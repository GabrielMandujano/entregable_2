# entregable_2
### CREACION DE LA BASE DE DATOS DBVENTAS
```sql
USE MASTER
GO
```
```sql
SET DATEFORMAT YMD
GO
```
```sql
IF DB_ID('BDVENTAS') IS NOT NULL
    DROP DATABASE BDVENTAS
GO
```
```sql
CREATE DATABASE BDVENTAS
GO
```
### CREACION DE TABLAS
**DISTRITO**
```sql
CREATE TABLE DISTRITO(
    COD_DIS CHAR(5) NOT NULL PRIMARY KEY,
    NOM_DIS VARCHAR(50) NOT NULL
)
GO
```
**VENDEDOR**
```sql
CREATE TABLE VENDEDOR(
    COD_VEN CHAR(3) NOT NULL PRIMARY KEY,
    NOM_VEN VARCHAR(20) NOT NULL,
    APE_VEN VARCHAR(20) NOT NULL,
    SUE_VEN MONEY NOT NULL,
    FTI_VEN DATE NOT NULL,
    TIP_VEN VARCHAR(10) NOT NULL,
    COD_DIS CHAR(5) NOT NULL REFERENCES DISTRITO
)
GO
```
**CLIENTE**
```sql
CREATE TABLE CLIENTE(
    COD_CLI CHAR(5) NOT NULL PRIMARY KEY,
    RSO_CLI CHAR(30) NOT NULL,
    DIR_CLI VARCHAR(100) NOT NULL,
    TLF_CLI CHAR(9) NOT NULL,
    RUC_CLI CHAR(11) NULL,
    COD_DIS CHAR(5) NOT NULL REFERENCES DISTRITO,
    FEC_REG DATE NOT NULL,
    TIP_CLI VARCHAR(10) NOT NULL,
    CON_CLI VARCHAR(30) NOT NULL
)
GO
```
**PROVEEDOR**
```sql
CREATE TABLE PROVEEDOR(
    COD_PRV CHAR(5) NOT NULL PRIMARY KEY,
    RSO_PRV VARCHAR(80) NOT NULL,
    DIR_PRV VARCHAR(100) NOT NULL,
    TEL_PRV CHAR(15) NULL,
    COD_DIS CHAR(5) NOT NULL REFERENCES DISTRITO,
    REP_PRV VARCHAR(80) NOT NULL
)
GO
```
**FACTURA**
```sql
CREATE TABLE FACTURA(
    NUM_FAC VARCHAR(12) NOT NULL PRIMARY KEY,
    FEC_FAC DATE NOT NULL,
    COD_CLI CHAR(5) NOT NULL REFERENCES CLIENTE,
    FEC_CAN DATE NOT NULL,
    EST_FAC VARCHAR(10) NOT NULL,
    COD_VEN CHAR(3) NOT NULL REFERENCES VENDEDOR,
    POR_IGV DECIMAL NOT NULL
)
GO
```
**ORDEN_COMPRA**
```sql
CREATE TABLE ORDEN_COMPRA(
    NUM_OCO CHAR(5) NOT NULL PRIMARY KEY,
    FEC_OCO DATE NOT NULL,
    COD_PRV CHAR(5) NOT NULL REFERENCES PROVEEDOR,
    FAT_OCO DATE NOT NULL,
    EST_OCO CHAR(1) NOT NULL
)
GO
```
**PRODUCTO**
```sql
CREATE TABLE PRODUCTO(
    COD_PRO CHAR(5) NOT NULL PRIMARY KEY,
    DES_PRO VARCHAR(50) NOT NULL,
    PRE_PRO MONEY NOT NULL,
    SAC_PRO INT NOT NULL,
    SMI_PRO INT NOT NULL,
	UNI_PRO VARCHAR(30) NOT NULL, 
    LIN_PRO VARCHAR(30) NOT NULL,
    IMP_PRO VARCHAR(10) NOT NULL
)
GO
```
**DETALLE_FACTURA**
```sql
CREATE TABLE DETALLE_FACTURA(
    NUM_FAC VARCHAR(12) NOT NULL REFERENCES FACTURA,
    COD_PRO CHAR(5) NOT NULL REFERENCES PRODUCTO,
    CAN_VEN INT NOT NULL,
    PRE_VEN MONEY NOT NULL,
    PRIMARY KEY (NUM_FAC, COD_PRO)
)
GO
```
**DETALLE_COMPRA**
```sql
CREATE TABLE DETALLE_COMPRA(
    NUM_OCO CHAR(5) NOT NULL REFERENCES ORDEN_COMPRA,
    COD_PRO CHAR(5) NOT NULL REFERENCES PRODUCTO,
    CAN_DET INT NOT NULL,
    PRIMARY KEY (NUM_OCO, COD_PRO)
)
GO
```
**ABASTECIMIENTO**
```sql
CREATE TABLE ABASTECIMIENTO(
    COD_PRV CHAR(5) NOT NULL REFERENCES PROVEEDOR,
    COD_PRO CHAR(5) NOT NULL REFERENCES PRODUCTO,
    PRE_ABA MONEY NOT NULL,
    PRIMARY KEY (COD_PRV, COD_PRO)
)
GO
```


-- Consultas simples
-- Consultar todos los productos:
SELECT * FROM PRODUCTO;

-- Consultar todos los proveedores:
SELECT *
FROM PROVEEDOR;

-- Listar los productos cuyo precio unitario es mayor a 30.
SELECT COD_PRO, DES_PRO
FROM PRODUCTO
WHERE PRE_PRO > 30;

--Listar los vendedores cuyo sueldo es mayor a 1400.
SELECT COD_VEN, NOM_VEN, APE_VEN
FROM VENDEDOR
WHERE SUE_VEN > 1400;

-- Listar todos los vendedores ordenados por apellido de manera descendente.
SELECT COD_VEN, NOM_VEN, APE_VEN
FROM VENDEDOR
ORDER BY APE_VEN DESC;



--CONSULTAS AVANZADAS
 -- Obtener la cantidad total de productos vendidos por cada vendedor.
 SELECT V.COD_VEN, V.NOM_VEN, V.APE_VEN, COUNT(DF.COD_PRO) AS TotalProductosVendidos
FROM VENDEDOR V
JOIN FACTURA F ON V.COD_VEN = F.COD_VEN
JOIN DETALLE_FACTURA DF ON F.NUM_FAC = DF.NUM_FAC
GROUP BY V.COD_VEN, V.NOM_VEN, V.APE_VEN;


-- Obtener el cliente con el mayor número de compras 
SELECT C.COD_CLI, C.CON_CLI, COUNT(F.NUM_FAC) AS NumeroCompras
FROM CLIENTE C
JOIN FACTURA F ON C.COD_CLI = F.COD_CLI
GROUP BY C.COD_CLI, C.CON_CLI
ORDER BY NumeroCompras DESC



--Obtener el número de productos distintos vendidos por cada cliente
SELECT C.COD_CLI, C.CON_CLI, COUNT(DISTINCT DF.COD_PRO) AS ProductosDistintos
FROM CLIENTE C
JOIN FACTURA F ON C.COD_CLI = F.COD_CLI
JOIN DETALLE_FACTURA DF ON F.NUM_FAC = DF.NUM_FAC
GROUP BY C.COD_CLI, C.CON_CLI;


--Obtener el vendedor que ha realizado la venta de mayor valor en una sola factura
SELECT V.COD_VEN, V.NOM_VEN, V.APE_VEN, F.NUM_FAC, MAX(DF.CAN_VEN * DF.PRE_VEN) AS MayorVenta
FROM VENDEDOR V
JOIN FACTURA F ON V.COD_VEN = F.COD_VEN
JOIN DETALLE_FACTURA DF ON F.NUM_FAC = DF.NUM_FAC
GROUP BY V.COD_VEN, V.NOM_VEN, V.APE_VEN, F.NUM_FAC
ORDER BY MayorVenta DESC

-- Obtener los nombres y apellidos de los vendedores que han vendido productos de un proveedor específico 
SELECT DISTINCT V.COD_VEN, V.NOM_VEN, V.APE_VEN
FROM VENDEDOR V
JOIN FACTURA F ON V.COD_VEN = F.COD_VEN
JOIN DETALLE_FACTURA DF ON F.NUM_FAC = DF.NUM_FAC
JOIN PRODUCTO P ON DF.COD_PRO = P.COD_PRO
WHERE P.COD_PRO = 'P016';



-- Trigger para actualizar stock post venta
USE DB_VENTAS
GO
CREATE OR ALTER TRIGGER tr_actualizar_stock_post_venta
ON DETALLE_FACTURA
AFTER INSERT
AS
BEGIN
    DECLARE @cod_pro CHAR(5)
    DECLARE @can_venta INT

    SELECT @cod_pro = i.COD_PRO,
           @can_venta = i.CAN_VEN
    FROM inserted i
UPDATE PRODUCTO
SET SAC_PRO = SAC_PRO - @can_venta
WHERE COD_PRO = @cod_pro
END
GO
